import json
from pathlib import Path

import typer
from rich import print
from rich.table import Table

from .utils import dotfile


app = typer.Typer()
DATA_FILE = Path("/home/daehyeon/sources/SDK/data.json")
with DATA_FILE.open("r") as fp:
    DATA = json.load(fp)

if DATA is None:
    DATA = {}

@app.command()
def register(
    name: str = typer.Argument(..., help=".envì˜ key"),
    file_path: str = typer.Argument(..., help=".envì˜ ë””ë ‰í† ë¦¬")) -> None:
    """
    ì…ë ¥ëœ ê²½ë¡œì— .env ìƒì„± ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš° data.jsonì— ë“±ë¡ë§Œ í•¨
    """
    destination = Path(file_path) / ".env"
    if not destination.exists():
        with destination.open("w") as fp:
            fp.write("# Generated By SDK")
    with DATA_FILE.open("w") as fp:
        DATA.update({name: str(destination)})
        json.dump(DATA, fp)
    print("Success!")


@app.command()
def check():
    """
    SDKì— ë“¤ë¡ëœ env files í™•ì¸
    """
    table = Table("KEY", "FILE PATH")
    for d in DATA.items():
        table.add_row(*d)
    print(table)


@app.command()
def show(name: str = typer.Argument(..., help=".envì˜ key")):
    """
    í•´ë‹¹ env fileì˜ ë³€ìˆ˜ ë³´ì—¬ì¤Œ
    """
    env_values = dotfile.get_dotenv_values(file_path=DATA[name])
    if len(env_values) == 0:
        print("[bold] NOTHING [bold] ğŸ˜…")
    else:
        table = Table("KEY", "VALUE")
        for item in env_values.items():
            table.add_row(*item)
        print(table)


@app.command()
def insert(
    name: str = typer.Argument(..., help=".envì˜ key"),
    key: str = typer.Argument(..., help="í™˜ê²½ë³€ìˆ˜ key"),
    value: str = typer.Argument(..., help="í™˜ê²½ë³€ìˆ˜ value")):
    """
    í•´ë‹¹ env fileì— ë³€ìˆ˜ Upsert
    """
    env_values = dotfile.get_dotenv_values(file_path=DATA[name])
    env_values[key] = value
    dotfile.save_dotenv_values(file_path=DATA[name], values=env_values)
    show(name)


@app.command()
def delete(
    name: str = typer.Argument(..., help=".envì˜ key"),
    key: str = typer.Argument(..., help="í™˜ê²½ë³€ìˆ˜ key")):
    """
    í•´ë‹¹ env fileì—ì„œ ë²ˆìˆ˜ ì œê±°
    """
    env_values = dotfile.get_dotenv_values(file_path=DATA[name])
    try:
        env_values.pop(key)
    except KeyError:
        print(f"[bold] {key} NOT FOUND [bold] ğŸ˜…")
    dotfile.save_dotenv_values(file_path=DATA[name], values=env_values)
    show(name)
